<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><title>揭秘mesh网格核心转发流程 | 诣极的博客</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="[object Object]"><meta name="designer" content="minfive"><meta name="keywords" content="incubator-dubbo, dubbo, 后端开发, 全栈开发, javascript, java"><meta name="description" content="花名诣极，开源Apache Dubbo PMC。曾就职于阿里巴巴集团、有赞科技，担任dubbo框架技术负责人。目前就职于蚂蚁金服中间件团队，主攻rpc和Service mesh方向。 ''深入理解Apache Dubbo与实战''图书作者。"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="https://zonghaishang.github.io/2021/08/27/揭秘mesh网格核心转发流程/index.html"><link rel="icon" type="image/png" href="null" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="诣极的博客"><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(null)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="诣极的博客" alt="诣极的博客"><img src="/images/yiji.png" alt="诣极的博客"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/tags" alt="标签" title="标签">标签</a></li><li class="nav__item"><a href="/categories" alt="类别" title="类别">类别</a></li><li class="nav__item"><a href="https://github.com/zonghaishang" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="null" alt="揭秘mesh网格核心转发流程"></div><header class="post__info"><h1 class="post__title">揭秘mesh网格核心转发流程</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="https://github.com/zonghaishang">诣极</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2021-08-27</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/mosn/">Mosn</a></li><li class="mark__item"><a href="/tags/service-mesh/">Service Mesh</a></li></ul></div></div></header><div class="post__content"><p>文档修订历史</p><table><thead><tr><th>版本号</th><th>作者</th><th>备注</th><th>修订日期</th></tr></thead><tbody><tr><td>0.1</td><td>诣极</td><td>初始版本</td><td>2021.8.27</td></tr></tbody></table><p>为了帮助同学深入掌握mesh转发核心流程，本文重点对mosn核心转发流程做了详细的梳理。详细流程图请参考图下方图1-1所示。</p><p>首先，mosn作为数据面，整体分为4层 (对应图1-1 从下往上分隔分层), 原始的mosn简介详见<a href="https://github.com/mosn/mosn/blob/0.1.0/docs/design/README.md" target="_blank" rel="noopener">doc</a> ：</p><ul><li>network/io 主要负责网络读写</li><li>protocol 主要负责协议编解码</li><li>stream 主要负责request、response等模型转发和协调</li><li>proxy 主要负责路由等功能。</li></ul><p>接下来，帮助同学清晰的掌握mosn的流程，整个流程简化为12个步骤，我会逐一拆解分析：</p><ol><li>mosn在启动期间，会暴露本地egress端口接收客户端app的rpc请求。mosn会开启2个协程，分别死循环去对tcp进行读取和写处理。mosn会通过读协程获取到请求字节流，进入mosn的协议层处理。</li><li>mosn会通过<a href="https://github.com/mosn/mosn/blob/d1e857f3dc0d4c6dfc8d17189d2300b7e0cfac78/pkg/stream/xprotocol/conn.go#L162" target="_blank" rel="noopener">streamconn</a>实现类中循环解码，直到解析到完整的请求报文。一旦解析到请求报文，会创建和请求frame关联的<a href="https://github.com/mosn/mosn/blob/d1e857f3dc0d4c6dfc8d17189d2300b7e0cfac78/pkg/stream/xprotocol/conn.go#L304" target="_blank" rel="noopener">xstream</a>。这里的xtream用来保持和客户端app的tcp关联，后续用来用于响应response。</li><li>mosn需要将请求转发到服务集群的某一台机器，会到达proxy层创建downstream, 有以下目的：<ul><li>执行filter请求/响应链</li><li>执行路由匹配</li><li>执行负载均衡</li></ul></li><li>在选择服务集群的某一台后，会首先初始化选中ip对应host的连接池，此时mosn的角色变成了中间人的角色。一方面需要承担客户端app的服务端，另一方面需要承担远程服务方的客户端。</li></ol><p><a href="https://github.com/mosn/mosn/blob/18e28b5fb9aa7a634736eb20ac321dc86e915067/pkg/proxy/downstream.go#L866" target="_blank" rel="noopener">upstreamrequest</a> 对象起到关键作用：</p><ul><li>保持着对客户端app的tcp引用，通过持有downstream</li><li>保持着对转发服务端tcp引用，转发客户端app请求以及响应服务端response时的通知<ol start="5"><li>在upstream的<a href="https://github.com/mosn/mosn/blob/18e28b5fb9aa7a634736eb20ac321dc86e915067/pkg/proxy/upstream.go#L177" target="_blank" rel="noopener">appendHeaders</a> + <a href="https://github.com/mosn/mosn/blob/18e28b5fb9aa7a634736eb20ac321dc86e915067/pkg/proxy/downstream.go#L903" target="_blank" rel="noopener">appendData</a>阶段，会用第4步骤中选择的host创建sender xstream, 这个xstream是客户端的流对象，主要有2个目的：</li></ol></li><li>充当client角色，初始化客户端请求信息，将待转发的请求创建对应的stream绑定关系</li><li>在真正转发前，需要替换请求id信息，用来解决连接io复用导致请求互相覆盖的问题<ul><li>混淆原因： 客户端app有多个tcp连接，mosn转发到服务端只有1条cp连接，如果客户端2个tcp连接同时有个id=1的request，mosn会通过同一条tcp转发给服务端，因此响应回来时，mosn没办法区分id=1的response属于哪个客户端app的tcp连接了。这里解决办法，mosn转发到服务端的1条tcp连接，会重新修改请求的id成全局，这个时候就不会混淆请求和响应关联关系了。<ol start="6"><li>因为mosn在转发之前修改了请求id，因此会重新encode请求，一般优化手段不会encode完整报文，只会修改协议头的个别几个字节。</li><li>一旦客户端xstream准备转发就绪(endOfStream)，就会通过第4步骤中选择下游host直接发送，此时请求的携程会被阻塞。</li><li>mosn转发给服务端host时，我们知道会新建tcp连接，与此同时也会每个tcp连接也会有2个携程去处理读写。mosn客户端xstream的会通过读io，收到响应byte字节流，并且交付上层protocol去解码。</li><li>一旦完整解码成response对象，会通知<a href="https://github.com/mosn/mosn/blob/d1e857f3dc0d4c6dfc8d17189d2300b7e0cfac78/pkg/stream/xprotocol/conn.go#L371" target="_blank" rel="noopener">upstream request</a>对象。</li><li>upstream request持有客户端请求的downstream, <a href="https://github.com/mosn/mosn/blob/18e28b5fb9aa7a634736eb20ac321dc86e915067/pkg/proxy/upstream.go#L124" target="_blank" rel="noopener">唤醒</a>downstream阻塞的协程。</li><li>对应步骤2中mosn作为服务方xstream被唤醒，会将收到的响应response, 重新替换回正确的reqest id，并能且去调用协议层重新encode成字节流。</li><li>xstream中持有客户端app请求时的tcp连接，直接将响应写会客户端，并且销毁mosn中所有请求相关的资源。至此，完整的请求响应流程在mosn中的流程介绍完毕。</li></ol></li></ul></li></ul><p><img src="https://zonghaishang.github.io/images/mosn核心流程.png" alt="mosn核心流程.png"><br>图 1-1 mosn核心流程转发</p><p>本文对完整的mosn转发流程做了关键的讲解，比如更多mosn中小功能点，比如buffer、router、connection pool的实现机制，会放到进阶原理篇给大家详细介绍。</p><div class="post-announce">感谢您的阅读，本文由 <a href="https://zonghaishang.github.io">诣极的博客</a> 版权所有。如若转载，请注明出处：诣极的博客（<a href="https://zonghaishang.github.io/2021/08/27/揭秘mesh网格核心转发流程/">https://zonghaishang.github.io/2021/08/27/揭秘mesh网格核心转发流程/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/2020/06/02/记一次对mosn中dubbo、hessian-go的性能优化/" title="记一次对mosn中dubbo、hessian-go的性能优化"><i class="iconfont icon-prev"></i>记一次对mosn中dubbo、hessian-go的性能优化</a></div><div class="post__prev post__prev--right"></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">花名诣极，开源Apache Dubbo PMC。曾就职于阿里巴巴集团、有赞科技，担任dubbo框架技术负责人。目前就职于蚂蚁金服中间件团队，主攻rpc和Service mesh方向。 ''深入理解Apache Dubbo与实战''图书作者。</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/工作经历/">工作经历</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/service-mesh/">service mesh</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/mosn/">mosn</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/jvm/">jvm</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/asm/">asm</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/arthas/">arthas</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Spring杂谈/">Spring杂谈</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Fastjson源码解析/">Fastjson源码解析</a><span class="block-list-count">11</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2021/08/27/揭秘mesh网格核心转发流程/" title="揭秘mesh网格核心转发流程"><div class="item__cover"><img src="undefined" alt="揭秘mesh网格核心转发流程"></div><div class="item__info"><h3 class="item__title">揭秘mesh网格核心转发流程</h3><span class="item__text">2021-08-27</span></div></a></li><li class="latest-post-item"><a href="/2020/06/02/记一次对mosn中dubbo、hessian-go的性能优化/" title="记一次对mosn中dubbo、hessian-go的性能优化"><div class="item__cover"><img src="/images/go.jpg" alt="记一次对mosn中dubbo、hessian-go的性能优化"></div><div class="item__info"><h3 class="item__title">记一次对mosn中dubbo、hessian-go的性能优化</h3><span class="item__text">2020-06-02</span></div></a></li><li class="latest-post-item"><a href="/2018/10/26/Ubuntu18.0.4.1编译openjdk8/" title="Ubuntu18.0.4.1编译openjdk8"><div class="item__cover"><img src="/images/jdk.jpg" alt="Ubuntu18.0.4.1编译openjdk8"></div><div class="item__info"><h3 class="item__title">Ubuntu18.0.4.1编译openjdk8</h3><span class="item__text">2018-10-26</span></div></a></li><li class="latest-post-item"><a href="/2018/10/26/理解arthas原理/" title="理解arthas原理"><div class="item__cover"><img src="/images/arthas.png" alt="理解arthas原理"></div><div class="item__info"><h3 class="item__title">理解arthas原理</h3><span class="item__text">2018-10-26</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Dubbo框架问题/">Dubbo框架问题</a></li><li class="tag-item"><a class="tag-link" href="/tags/Fastjson源码解析/">Fastjson源码解析</a></li><li class="tag-item"><a class="tag-link" href="/tags/Spring杂谈/">Spring杂谈</a></li><li class="tag-item"><a class="tag-link" href="/tags/arthas/">arthas</a></li><li class="tag-item"><a class="tag-link" href="/tags/asm/">asm</a></li><li class="tag-item"><a class="tag-link" href="/tags/dubbo/">dubbo</a></li><li class="tag-item"><a class="tag-link" href="/tags/go/">go</a></li><li class="tag-item"><a class="tag-link" href="/tags/jvm/">jvm</a></li><li class="tag-item"><a class="tag-link" href="/tags/jvm-openjdk/">jvm, openjdk</a></li><li class="tag-item"><a class="tag-link" href="/tags/mosn/">mosn</a></li><li class="tag-item"><a class="tag-link" href="/tags/openjdk/">openjdk</a></li><li class="tag-item"><a class="tag-link" href="/tags/service-mesh/">service mesh</a></li><li class="tag-item"><a class="tag-link" href="/tags/工作经历/">工作经历</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">关于</h3><div class="item__content"><p class="item__text">诣极的博客，主要用于分享日常学习和工作的一些心得总结。</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Hangzhou, Zhejiang Province, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>yiji@apache.org</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="/images/jmj.png" alt="logo" title="诣极的博客"></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="" target="_blank">Blog</a> 2018 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/zonghaishang" target="_blank">诣极</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/zonghaishang" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:yiji@apache.org" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li><li class="social-network__item"><a href="https://zonghaishang.github.io/" target="_blank" title="rss"><i class="iconfont icon-rss"></i></a></li></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>